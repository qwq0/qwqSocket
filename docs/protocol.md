# QwQ socket 协议

若在服务器和客户端都使用此协议库而不手动实现此协议  
则无需阅读此协议文档

QwQ socket 是一种载体无关(传输层协议 / 应用层协议 / 序列化方式)的高级协议  
单个数据包由 一个字符串 prefix 和 一个 js 对象 body 组成  
常见的 QwQ socket 的使用组合是与 websocket + json(或 jsobin)

## QwQ Server and Client Socket 协议

基于服务器和客户端的通信协议
注意 所有的 简短名 和 元对象的值的传递顺序 都是由服务端定义的

允许的事件名字符: 数字 大写或小写字母 下划线(\_) 连字符(-)  
注意 连字符(-) 由 QwQ socket 内部协议使用 不应手动使用带连字符的事件名

简短名格式: 一个 36 进制整数的字符串(由 数字 和 小写字母 组成)

当服务端首次调用某一客户端事件时 应当发送 (+)开头的数据包  
之后调用此事件的数据包应当为通过简短名调用

当客户端首次调用某一服务端事件时 应该发送 (\*)开头的数据包  
之后服务端将向客户端发送以 (=)开头的数据包 告知客户端简短名  
客户端接受到此数据包后再调用此事件时应当发送简短名数据包

### 客户端 -> 服务器 协议

-   prefix
    -   通过简短名调用事件  
        (0-9 或 a-z 开头的字符串)  
        表示以简短名触发服务端事件  
        body 为一个数组  
        数组中的元素为 按已定义的顺序传递事件元对象的值
    -   通过事件名调用事件  
        (以 \* 开头的字符串)  
        表示以事件名触发服务端事件  
        body 为事件的元对象

### 服务器 -> 客户端 协议

-   prefix
    -   通过简短名调用事件  
        (0-9 或 a-z 开头的字符串)  
        表示以简短名触发客户端事件  
        body 为一个数组  
        数组中的元素为 按已定义的顺序传递事件元对象的值
    -   通过事件名调用事件
        (以 \* 开头的字符串)  
        表示以事件名触发客户端事件  
        body 为事件的元对象
    -   调用事件并告知简短名  
        (以 + 开头的字符串)  
        表示以事件名触发事件  
        同时告知此客户端事件的简短名和元对象的键顺序  
        body 为一个对象
        -   key 表示元对象的键顺序数组
        -   value 按已定义的顺序传递事件元对象的值  
            不传递 value 表示仅告知信息而不立即调用
        -   short 表示此事件的简短名
    -   告知对端简短名  
        (以 = 开头的字符串)  
        表示告知服务端的事件的简短名和元对象顺序  
        body 为一个对象
        -   key 表示元对象的键顺序数组
        -   short 表示此事件的简短名

## 事件名协议

用户事件标识符  
由 数字 大写或小写字母 下划线(\_) 组成

-   事件
    -   普通事件 (用户事件标识符)  
        普通的用户事件  
        元对象中无特殊键  
        所有的键为用户定义的内容
    -   请求事件 (用户事件标识符 + "-req")  
        发起一个请求 等待响应事件  
        元对象有一个键为 "-query-id" 值为字符串型 用于标识请求  
        其余的键为用户定义的内容
    -   响应事件 (用户事件标识符 + "-rsp")  
        响应一个请求事件  
        元对象有一个键为 "-query-id" 与 请求事件 中一致  
        其余的键为用户定义的内容
    -   错误响应事件 (用户事件标识符 + "-ersp")  
        告知响应请求事件时发生错误  
        元对象有一个键为 "-query-id" 与 请求事件 中一致  
        元对象有一个键为 "-cause" 值为 字符串 或 undefined 表示错误原因  
        没有用户定义的键

## QwQ Peer Socket 协议

基于端到端的通信协议

todo 还没写
